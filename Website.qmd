---
title: "The Effects of Highways on Guanaco Movement in Patagonia"
format:
  html:
    code-fold: true
    self-contained: true
---

```{r}
#| message: false
#| warning: false
#| echo: false

library(tidyverse)
library(plotly)
library(scales)
library(ggplot2)
library(sf)
library(ggspatial)
library(mapview)
library(prettymapr)
library(gganimate)
library(gifski)
library(av)
library(rnaturalearth)
library(rnaturalearthdata)
library(cowplot)
library(ggspatial)
library(magick)
library(kableExtra)

mapviewOptions(fgb = FALSE)

g_park_roads <- read_csv("/Users/zoefairlie/Desktop/Thesis/g_park_roads.csv")
g_visitors <- read_csv("/Users/zoefairlie/Desktop/Thesis/g_visitors.csv")
g_highway <- read_csv("/Users/zoefairlie/Desktop/Thesis/g_highway.csv")


highway_cross_table <- g_highway %>% mutate(sex = case_when(female == 1 ~ 'Female',
                                                            T ~ 'Male'),
                                            tod = case_when(day == 1 ~ 'Day',
                                                            T ~ 'Night'),
                                            season = case_when(summer == 1 ~ 'Summer',
                                                               T ~ 'Winter'),
                                            road_type = 'Highway') %>% 
  select(road_type, cross_dummy, sex, tod, season)

visitor_cross_table <- g_visitors %>% mutate(sex = case_when(female == 1 ~ 'Female',
                                                            T ~ 'Male'),
                                            tod = case_when(day == 1 ~ 'Day',
                                                            T ~ 'Night'),
                                            season = case_when(summer == 1 ~ 'Summer',
                                                               T ~ 'Winter'),
                                            road_type = 'Visitor Road') %>% 
  select(road_type, cross_dummy, sex, tod, season)

park_cross_table <- g_park_roads %>% mutate(sex = case_when(female == 1 ~ 'Female',
                                                             T ~ 'Male'),
                                             tod = case_when(day == 1 ~ 'Day',
                                                             T ~ 'Night'),
                                             season = case_when(summer == 1 ~ 'Summer',
                                                                T ~ 'Winter'),
                                             road_type = 'Park Roads') %>% 
  select(road_type, cross_dummy, sex, tod, season)

color_pal <- c('#fedc56','#ff9e4d', '#d95d67', '#c5488c') 

rutas <- st_read("/Users/zoefairlie/Desktop/Thesis/rutas_all_roads.shp", quiet = TRUE)
highway <- st_read("/Users/zoefairlie/Desktop/Thesis/highway.shp", quiet = TRUE)
tourist <- st_read("/Users/zoefairlie/Desktop/Thesis/caminos2.shp", quiet = TRUE)
park_roads <-st_read("/Users/zoefairlie/Desktop/Thesis/park_roads.shp", quiet = TRUE)

tourist <- st_transform(tourist, st_crs(highway))
park_roads <- st_transform(park_roads, st_crs(highway))

road_data = highway %>% mutate(type = 'Highway') %>% select(type) %>%
  rbind(tourist %>% mutate(type = 'Visitor Road') %>% select(type)) %>%
  rbind(park_roads %>% mutate(type = 'Park Roads') %>% select(type)) %>%
  st_cast("LINESTRING")  %>%
  st_as_sf() %>%
  group_by(type) %>%
  summarise(geometry = st_union(geometry))

park_outline <- st_read("/Users/zoefairlie/Desktop/Thesis/shapefiles_monteleon/pn_monteleon.shp", quiet = TRUE) %>%
  st_transform(st_crs(highway))

```
## Introduction

Habitat connectivity is vital for ungulates, enabling access to key resources and maintaining gene flow among populations.
Expanding linear infastructure such as roads fragment their habitats and restrict movement.
Guanacos, South America’s most widespread native ungulate, have declined drastically and remain understudied regarding roadway impacts in the Patagonian steppe. 
This study uses GPS data from Monte León National Park, Argentina, to examine how guanaco movement responds to a major highway.


## Research Questions

How does highway traffic constrain guanaco movement? 
Do guanacos respond differently to roads with varying traffic volumes?

To analyze the effects of traffic, I compared guanaco interactions with the main highway as well as two additional roads that differ in traffic intensity: a visitor road that connects the highway to the park and smaller, unpaved roads used by park staff.

## Hypotheses and Predictions

I hypothesize that guanaco movement will be impacted by the highway and that guanancos will avoid crossing roads with high traffic.

- In general guanacos will avoid crossing the highway.
- Guanacos will be more likely to cross the highway at night because there is less traffic and guanacos may exhibit diel shifts in proximity to humans.
- Female guanacos will be less likely to cross the highway because they have chulengos (baby guanacos).


To further test these hypotheses and predictions, I examined whether differences in guanaco behavior between the highway and visitor roads are greater during the daytime, when vehicular traffic is higher, than at night, when traffic is lower.

## Study Area
Monte León National Park (MLNP)

- 61,000 ha along 30 km of coastline in the Patagonian Steppe  
- Bounded by Route 3 and the Atlantic Ocean 

Highway: two lane road that extends from Buenos Aires to the tip of Argentina, making it a major transportation route for the country with high volumes of traffic.

Visitors Road: two lane road that takes tourists from the highway to the ocean through MLNP.

Park Use Roads: a small dirt road system only used by park officials.


```{r, message= F, warning=F, echo=F}

sa <- ne_countries(continent = "South America", returnclass = "sf")

monte_leon_center <- st_point(c(-68.898, -50.266)) %>%
  st_sfc(crs = 4326)

# Small bounding box (~25 km each direction)
buffer_deg <- 0.25
monte_leon_bbox <- st_bbox(st_buffer(monte_leon_center, dist = buffer_deg))

main_map <- ggplot() +
  geom_sf(data = sa, color = "black", fill = "white", linewidth = 0.4) +
  geom_sf(data = monte_leon_center, color = "grey25",fill = color_pal[1], size = 5, shape = 21 ) +
  theme_void() +
  annotation_north_arrow(height = unit(1, 'cm'), width = unit(1, 'cm'), style = north_arrow_fancy_orienteering, location = 'tr')+
  theme(panel.background = element_rect(fill = "white", color = NA))

map_tile <- annotation_map_tile(type =
    paste0('https://services.arcgisonline.com/arcgis/rest/services/NatGeo_World_Map',
                '/MapServer/tile/${z}/${y}/${x}.jpeg'),
  zoom = 9,
  cachedir = "tile_cache",
  alpha = 1)

# Get the bounding box of the visitor road
visitor_bbox <- sf::st_bbox(park_outline)

# Optionally, add a small buffer so the road isn’t right at the edge
buffer <- 0.1  # degrees; adjust as needed
visitor_bbox[1] <- visitor_bbox[1] - buffer  # xmin
visitor_bbox[2] <- visitor_bbox[2] - buffer  # ymin
visitor_bbox[3] <- visitor_bbox[3] + buffer  # xmax
visitor_bbox[4] <- visitor_bbox[4] + buffer  # ymax

# Then use that in coord_sf()
mymap <- ggplot(data = road_data) +
  map_tile +
  geom_sf(data = park_outline, aes(fill = 'Park Boundary'),color = color_pal[1], size = .7, alpha = .3) +
  scale_fill_manual(name = element_blank(), values = c('Park Boundary' = color_pal[1]),
                    guide = guide_legend(override.aes = list(keyheight = unit(.2, 'cm'),
                                                             linetype = "blank", shape = NA))) +
  geom_sf(data = road_data, aes(color = type, size = type),
          alpha = 0.8, show.legend = "line") +
  scale_color_manual(
    name = element_blank(),
    values = c('Highway' = '#d95d67',
               'Visitor Road' = '#ff9e4d',
               'Park Roads' = '#A9866D',
               'Park Boundary' = NA),
               guide = guide_legend(override.aes = list(linewidth = c(2,1,.5)))
  ) +
  scale_size_manual(
    name =  element_blank(),
    values = c('Highway' = 2,
               'Visitor Road' = 1,
               'Park Roads' = 0.5,
               "Park Boundary" = NA)
  ) +
  coord_sf(
    xlim = c(visitor_bbox["xmin"], visitor_bbox["xmax"]),
    ylim = c(visitor_bbox["ymin"], visitor_bbox["ymax"]),
    expand = FALSE
  ) +
  theme_void() +
  annotation_scale(style = 'ticks', location = 'bl', unit_category = 'imperial') +
  theme(
    legend.position = c(.7, .25),
    legend.box.background = element_rect(fill = alpha("white", .8),
                                         color = 'grey35',
                                         linewidth = .5),
    legend.box.margin = margin(5,5,5,5),
    panel.grid = element_blank(),
    plot.margin = margin(1, 1, 1, 1, unit = "pt"),
    plot.background = element_rect(color = 'grey35', fill = NA, linewidth = 1)
  )

final_plot <- ggdraw() +
  draw_plot(main_map) +
  draw_plot(mymap, x = 0.5, y = 0.25, width = .6, height = 0.6) +
  draw_line(
    x = c(0.72, 0.42),  # tweak these for your liking
    y = c(0.25, 0.12),
    color = "grey35",
    size = 0.6
  ) + 
  draw_line(
    x = c(0.58, 0.42),  # tweak these for your liking
    y = c(0.5, 0.12),
    color = "grey35",
    size = 0.6
  )

final_plot

```


### Example Guanaco Movement

```{r, message= F, warning=F, echo=F}
#| message: false
#| warning: false
#| echo: false

# shape <- st_read("/Users/zoefairlie/Desktop/Thesis/shapefiles_monteleon/catastro_stacruz.shp", quiet = TRUE)
# shape_2 <- st_read("/Users/zoefairlie/Desktop/Thesis/shapefiles_monteleon/pn_monteleon.shp", quiet = TRUE)
# 
# g_highway_sf <- g_highway %>% 
#   st_as_sf(coords = c("easting", "northing"), crs = st_crs(highway))
# g_visitors_sf <- g_visitors %>% 
#   st_as_sf(coords = c("easting", "northing"), crs = st_crs(highway))
# g_park_roads_sf <- g_park_roads %>% 
#   st_as_sf(coords = c("easting", "northing"), crs = st_crs(highway))
# 
# guanacos <- read.csv('/Users/zoefairlie/Desktop/Thesis/Thesis Presentation/raw_guanaco_data.csv')
# 
# test_cross <- g_highway %>% filter(AnimalID == 6 & cross == 1) %>%
#   mutate(date = as.POSIXct(start_time))
# 
# test <- guanacos %>% filter(Animal.ID == 6) %>%
#   arrange(date) %>%
#   mutate(X = fct_inorder(as.character(X)),
#          date = as.POSIXct(date, format = "%y-%m-%d %H:%M:%S"))%>% 
#   st_as_sf(coords = c("Longitude", "Latitude"), crs = st_crs(highway)) %>%
#   filter(date > as.POSIXct("2020-12-06 00:00:00") & 
#          date < as.POSIXct('2020-12-09 24:00:00'))
#   
#   
# test_path_sf <- test %>%
#   group_by(Animal.ID) %>%
#   summarise(do_union = FALSE) %>%
#   st_as_sf(
#     coords = c("Longitude", "Latitude"),
#     crs = st_crs(highway)
#   ) %>%
#   summarise(geometry = st_combine(geometry)) %>%
#   st_cast("LINESTRING")
# 
# map_tile <- annotation_map_tile(
#   type = "cartolight", 
#   zoom = 12,
#   cachedir = "tile_cache",  
#   alpha = 0.9
# )
# 
# # 1️⃣ Get bounding box of your data
# bbox <- st_bbox(test)
# 
# # 2️⃣ Calculate width & height
# x_range <- bbox$xmax - bbox$xmin
# y_range <- bbox$ymax - bbox$ymin
# 
# # 3️⃣ Find the larger side and pad the smaller one
# if (x_range > y_range) {
#   diff <- x_range - y_range
#   bbox$ymin <- bbox$ymin - diff / 2
#   bbox$ymax <- bbox$ymax + diff / 2
# } else {
#   diff <- y_range - x_range
#   bbox$xmin <- bbox$xmin - diff / 2
#   bbox$xmax <- bbox$xmax + diff / 2
# }
# 
# x_buffer <- (bbox$xmax - bbox$xmin) * 0.30
# y_buffer <- (bbox$ymax - bbox$ymin) * 0.3
# 
# # 3️⃣ Expand the bbox
# bbox_expanded <- bbox
# bbox_expanded$xmin <- bbox$xmin - x_buffer
# bbox_expanded$xmax <- bbox$xmax + x_buffer
# bbox_expanded$ymin <- bbox$ymin - y_buffer
# bbox_expanded$ymax <- bbox$ymax
# 
# 
# mymap <- ggplot(data = road_data) + 
#   map_tile +
#   geom_sf(data = road_data, aes(color = type,size = type), alpha = 0.6, show.legend = "line") +
#     scale_color_manual(name = 'Road Type',
#     values = c('Highway' = '#d95d67', 'Visitor Road' = '#ff9e4d', 
#                                 'Park Roads' = '#A9866D')) +
#   scale_size_manual(name = 'Road Type',
#                     values = c('Highway' = 2, 'Visitor Road' = 1, 
#                                 'Park Roads' = .5))+
#   geom_sf(data = test, fill = '#fedc56', color = '#e3b623', shape = 21, alpha = .9, size = 5) +
#   geom_sf(data = test_path_sf, color = 'grey70', alpha = 0.2, size = 1) +
# 
#   # geom_point(aes(x = Longitude, y = Latitude), shape = 16, alpha = .3) +
#   # scale_color_manual(name = 'id',
#   #                   values = color_pal[1]) +
#   #geom_path(data = test, aes(x = Longitude, y = Latitude)) +
#   # scale_colour_manual(name = "Bird ID",
#   #                     values = rainbow(length(unique(tracksgeo$id))),
#   #                     breaks = unique(tracksgeo$id)) + 
#   coord_sf(
#     xlim = c(bbox_expanded$xmin, bbox_expanded$xmax),
#     ylim = c(bbox_expanded$ymin, bbox_expanded$ymax),
#     expand = FALSE
#   ) +
#   theme_void() + 
#   theme(legend.position = 'right',
#     panel.grid = element_blank())
# 
# 
# path.animate.plot <- mymap +
#   transition_time(date) +
#   shadow_wake(
#     wake_length=1.5,
#     size = TRUE,
#     alpha = TRUE,
#     colour = 'grey92',
#     fill = NULL,
#     falloff = "cubic-in",
#     wrap = TRUE,
#     exclude_layer = NULL,
#     exclude_phase = c("enter", "exit")
#   ) +
# labs(title = 'Guanaco GPS Tracking: {frame_time}')
# 
# 
# animation_g <-animate(path.animate.plot, fps = 5,
#   width = 800, height = 600, res = 100,
#   nframes = nrow(test), renderer = av_renderer())
# 
# anim_save(filename = '/Users/zoefairlie/Desktop/Website/www/guanaco_animate.mp4', animation = animation_g) 

```

## Model 
To analyze guanacos’ interaction with the barrier I used Barrier Behavior Analysis (BaBA) which is a spatial analysis package that classifies barrier interaction types. 

- I assumed that if the guanaco is using the habitat equally there will be a 50% chance it crosses an arbitrary barrier. 

$H_0: \beta_{highway} = \beta_{visitor} = \beta_{park\ roads} = 0.5$

$H_A: \beta_{highway} < \beta_{visitor} \text{ and } \beta_{highway} < \beta_{park\ roads}$

## Results
### Exploratory Findings

- 66.4% of highway crossings occurred during the summer months (p < 0.05)

- 64.7% of highway crossings occurred during daytime.
 
- 29.3% of highway crossing events were by male guanacos (p < 0.05), indicating that females were more likely to cross. 

 These results contrast with my initial prediction that female guanacos would be less likely to cross the highway. 
 One possible explanation is that females may travel in larger groups, increasing their likelihood of crossing, whereas males are more solitary and potentially less bold. 
 Further investigation is needed to better understand these behavioral patterns.

### Figure 1: Differences in Road Crossings
:::panel-tabset

### Sex
```{r, message= F, warning=F, echo=F}

#| label: fig_1
#| fig-cap = "Sex"

sex_figure = highway_cross_table %>%
  rbind(visitor_cross_table) %>% rbind(park_cross_table) %>%
  group_by(road_type) %>%
  mutate(total_road_cross = sum(cross_dummy)) %>%
  ungroup() %>%
  group_by(road_type, sex) %>%
  summarise(total_crosses = sum(cross_dummy), cross_share = total_crosses/max(total_road_cross)) %>%
  mutate(road_type = fct_reorder(road_type, total_crosses)) %>%
  mutate(label= paste0('Count: ', comma(total_crosses),
                       '\nShare: ', percent(cross_share, accuracy = .1)))

# duration = (max(g_highway$end_time)-min(g_highway$start_time))/30.25

plot_ly(data = sex_figure ,
       x = ~fct_reorder(road_type, total_crosses),
       y = ~total_crosses,
       color = ~sex,
       colors = color_pal[2:3],
       type = 'bar',
       textposition = 'none') %>%
  layout(barmode = 'stack',
         font = list(family = "Garamond", color = 'grey20'),
         title = "",
         yaxis = list(title = "Number of Road Crosses",
                      tickformat = ",.0f"),
         xaxis = list(title = ""),
         hovermode = 'x unified',
         legend = list(title = list(text = '<b> Sex'),
                        y =.5,
                        yanchor = 'top')) %>%
  config(displayModeBar = FALSE)

```

### Time of Day 
```{r, message= F, warning=F, echo=F}

#| label: fig_1
#| fig-cap = "Sex"

tod_figure = highway_cross_table %>%
  rbind(visitor_cross_table) %>% rbind(park_cross_table) %>%
  group_by(road_type) %>%
  mutate(total_road_cross = sum(cross_dummy)) %>%
  ungroup() %>%
  group_by(road_type, tod) %>%
  summarise(total_crosses = sum(cross_dummy), cross_share = total_crosses/max(total_road_cross)) %>%
  mutate(road_type = fct_reorder(road_type, total_crosses)) %>%
  mutate(label= paste0('Count: ', comma(total_crosses),
                       '\nShare: ', percent(cross_share, accuracy = .1)))
plot_ly(data = tod_figure ,
        x = ~fct_reorder(road_type, total_crosses),
        y = ~total_crosses,
        color = ~tod,
        colors = color_pal[2:3],
        type = 'bar',
        textposition = 'none') %>% 
  layout(barmode = 'stack',
         font = list(family = "Garamond", color = 'grey20'),
         title = "",
         yaxis = list(title = "Number of Road Crosses",
                      tickformat = ",.0f"),
         xaxis = list(title = ""),
         hovermode = 'x unified',
         legend = list(title = list(text = '<b> Time of Day'),
                        y =.5,
                        yanchor = 'top')) %>%
  config(displayModeBar = FALSE)

```


### Season
```{r, message= F, warning=F, echo=F}

#| label: fig_1
#| fig-cap = "Sex"

season_figure = highway_cross_table %>%
  rbind(visitor_cross_table) %>% rbind(park_cross_table) %>%
  group_by(road_type) %>%
  mutate(total_road_cross = sum(cross_dummy)) %>%
  ungroup() %>%
  group_by(road_type, season) %>%
  summarise(total_crosses = sum(cross_dummy), cross_share = total_crosses/max(total_road_cross)) %>%
  mutate(road_type = fct_reorder(road_type, total_crosses)) %>%
  mutate(label= paste0('Count: ', comma(total_crosses),
                       '\nShare: ', percent(cross_share, accuracy = .1)))
plot_ly(data = season_figure ,
        x = ~fct_reorder(road_type, total_crosses),
        y = ~total_crosses,
        color = ~season,
        colors = color_pal[2:3],
        type = 'bar',
        textposition = 'none') %>% 
  layout(barmode = 'stack',
         font = list(family = "Garamond", color = 'grey20'),
         title = "",
         yaxis = list(title = "Number of Road Crosses",
                      tickformat = ",.0f"),
         xaxis = list(title = ""),
         hovermode = 'x unified',
         legend = list(title = list(text = '<b> Season'),
                        y =.5,
                        yanchor = 'top')) %>%
  config(displayModeBar = FALSE)

```
:::

::: {.column-marign}
Note: Guanaco data collection occurred October 2019 through November 2021.
:::

### Average Movement

<video width="720" height="480" controls>
  <source src="www/guanaco_animate.mp4" type="video/mp4">
</video>

MLG06: Average Movement, Female

### Trapped

<video width="720" height="480" controls>
  <source src="www/guanaco_animate_trapped.mp4" type="video/mp4">
</video>

MLG08: Trapped, Female

10 of the 4668 interactions were classified as “Quick Cross”, meaning that only 10 of the 116 highway crosses took place within 2 hours of being 80 meters
from the highway. 

### Guanaco Behavioral Responses

```{r, message= F, warning=F, echo=F}
summary_highway <- read_csv("/Users/zoefairlie/Desktop/Thesis/highway_interaction_table.csv") %>%
  mutate(`Number of Interactions` = comma(`Number of Interactions`, accuracy = 1))

kable(summary_highway, 
      caption = "Summary Statistics with Highway as Barrier",
      row.names = FALSE, 
      align = c("l", "r","r","r")) %>%
  kable_styling(full_width = FALSE)
```


## Model Results

To test whether guanacos avoid crossing the highway due to traffic, I created two interaction variables combining the highway and visitor roads with a daytime binary variable. 
The coefficients on these interaction terms capture the additional impact of crossing busy roads, using daytime as a proxy for higher traffic. 

When these interactions are included, we find that guanacos are 7.4% ± 1.6% (p < 0.05) and 7.7% ± 1.7% (p < 0.05; see Appendix Table 2) less likely to cross the highway and visitor road, respectively, beyond the baseline likelihood of crossing during the day. 
This reduction is likely attributable to traffic-related avoidance or increased perceived risk.
 Notably, this model is the most explanatory, as it has the lowest AIC value among those tested.


### Model Comparison (AIC Values)

```{r echo=FALSE, message=FALSE, warning=FALSE, out.width="100%"}
#| echo: false
#| message: false
#| warning: false

# Load the AIC image and crop the top portion
library(magick)

# Read the image
aic_img <- image_read("www/aic.jpg")

# Get image dimensions
img_info <- image_info(aic_img)
height <- img_info$height
width <- img_info$width

crop_height <- round(height * 0.1)
cropped_img <- image_crop(aic_img, paste0(width, "x", height - crop_height, "+0+", crop_height))

# Save the cropped image temporarily
image_write(cropped_img, "www/aic_cropped.jpg")

# Display the cropped image
knitr::include_graphics("www/aic_cropped.jpg")
```

My results indicated that paved roads significantly affect guanaco movement, with vehicular traffic being a major contributing factor.
 However, other factors may also influence highway avoidance, including differences in vegetation and habitat on either side of the road, as well as fear of poaching, since private land borders the highway. 
Future research should investigate these alternative hypotheses and the potential role of fencing.


### Regression Table

<iframe src="www/regint.html" width="100%" height="670px" style="border: none;" title="Regression Table"></iframe>


From a conservation perspective, these findings highlight that roadways can fragment guanaco habitat. When planning new national parks or conservation areas, park managers should consider connectivity across roads. 
Strategies such as wildlife crossing structures could help mitigate the negative effects of traffic and maintain mobility for guanaco populations.